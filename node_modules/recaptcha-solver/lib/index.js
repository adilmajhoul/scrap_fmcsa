"use strict";var V=Object.create;var b=Object.defineProperty;var z=Object.getOwnPropertyDescriptor;var j=Object.getOwnPropertyNames;var G=Object.getPrototypeOf,J=Object.prototype.hasOwnProperty;var K=(e,o)=>{for(var t in o)b(e,t,{get:o[t],enumerable:!0})},T=(e,o,t,a)=>{if(o&&typeof o=="object"||typeof o=="function")for(let c of j(o))!J.call(e,c)&&c!==t&&b(e,c,{get:()=>o[c],enumerable:!(a=z(o,c))||a.enumerable});return e};var m=(e,o,t)=>(t=e!=null?V(G(e)):{},T(o||!e||!e.__esModule?b(t,"default",{value:e,enumerable:!0}):t,e)),Q=e=>T(b({},"__esModule",{value:!0}),e);var te={};K(te,{BFRAME:()=>f,MAIN_FRAME:()=>h,NotFoundError:()=>v,exists:()=>I,solve:()=>D});module.exports=Q(te);var N=require("child_process"),d=m(require("fs")),x=m(require("path")),B=m(require("os")),W=require("stream"),k=m(require("vosk-lib")),q=m(require("wav"));function n(...e){process.env.VERBOSE&&console.log("[reCAPTCHA solver]",...e)}var H=m(require("path")),L=H.default.resolve(__dirname,"..","model"),S="sound.mp3",M="out.wav",h="iframe[title='reCAPTCHA']",f="iframe[src^='https://www.google.com/recaptcha/api2/bframe'], iframe[src^='https://www.google.com/recaptcha/enterprise/bframe']",g="body > div > div";var P=class{constructor(o="Mutex"){this.name=o;this._locked=!1;this._queue=[]}async lock(o){if(this._locked)return o&&n(`[${this.name}] ${o} waiting`),new Promise(t=>{this._queue.push(()=>{this._lock(o),t()})});this._lock(o)}unlock(o){var t;this._locked&&(o&&n(`[${this.name}] ${o} unlocked`),this._locked=!1,(t=this._queue.shift())==null||t())}_lock(o){this._locked=!0,o&&n(`[${this.name}] ${o} locked`)}};function O(e){return new Promise(o=>setTimeout(o,e))}async function I(e){return!!e.$(f)}k.default.setLogLevel(-1);var X=new k.default.Model(L),v=class extends Error{constructor(o){super(o),this.name="NotFoundError"}};async function D(e,{delay:o=64,wait:t=5e3,retry:a=3,ffmpeg:c="ffmpeg"}={}){try{await e.waitForSelector(f,{state:"attached"})}catch{throw new Error("No reCAPTCHA detected")}let w=!1,A=await e.$(f);if(A===null)throw new Error("Could not find reCAPTCHA popup iframe");let i=await A.contentFrame();if(i===null)throw new Error("Could not find reCAPTCHA popup iframe content");let l=!!await i.$(g);if(n("bframe loaded:",l),l===!1){await e.waitForSelector(h,{state:"attached"});let r=await e.$(h);if(r===null)throw new Error("Could not find reCAPTCHA iframe");let s=await r.contentFrame();if(s===null)throw new Error("Could not find reCAPTCHA iframe content");if(w=!!await s.$("div.rc-anchor-invisible"),n("invisible:",w),w===!0)return!1;{let R=await s.$("#recaptcha-anchor-label");if(R===null)throw new Error("Could not find reCAPTCHA label");await R.click(),await i.waitForSelector(g)}}let C=await i.$(g);if(C===null)throw new Error("Could not find reCAPTCHA challenge");let y=await C.evaluate(r=>!r.classList.contains("rc-footer"));if(n("action required:",y),y===!1)return!1;await i.waitForSelector("#recaptcha-audio-button",{timeout:t});let E=await i.$("#recaptcha-audio-button");if(E===null)throw new Error("Could not find reCAPTCHA audio button");let u=new P;await u.lock("init");let p=!1,F=Promise.resolve(""),$=async r=>{if(r.headers()["content-type"]==="audio/mp3")n(`got audio from ${r.url()}`),F=new Promise(s=>{oe(r,c).then(s).catch(()=>{})}),u.unlock("get sound");else if(r.url().startsWith("https://www.google.com/recaptcha/api2/userverify")){let s=(await r.body()).toString().replace(`)]}'
`,"");p=JSON.parse(s)[2]===1,u.unlock("verified")}};e.on("response",$),await E.click();let U=0;for(;p===!1;){if(U++>=a)throw new Error("Could not solve reCAPTCHA");await Promise.race([u.lock("ready"),O(t).then(()=>{throw new v("No Audio Found")})]),await i.waitForSelector("#audio-source",{state:"attached",timeout:t}),await i.waitForSelector("#audio-response",{timeout:t}),n("reconized:",await F);let r=await i.$("#audio-response");if(r===null)throw new Error("Could not find reCAPTCHA audio input");await r.type(await F,{delay:o});let s=await i.$("#recaptcha-verify-button");if(s===null)throw new Error("Could not find reCAPTCHA verify button");await s.click(),await u.lock("done"),n("passed:",p)}return e.off("response",$),!0}function Y(){let e=x.default.resolve(B.default.tmpdir(),"reSOLVER-"+Math.random().toString().slice(2));return d.default.existsSync(e)&&d.default.rmSync(e,{recursive:!0}),d.default.mkdirSync(e,{recursive:!0}),e}function Z(e,o="ffmpeg"){(0,N.spawnSync)(o,["-loglevel","error","-i",S,"-acodec","pcm_s16le","-ac","1","-ar","16000",M],{cwd:e,stdio:process.env.VERBOSE?"inherit":"ignore"})}function ee(e){return new Promise(o=>{let t=d.default.createReadStream(x.default.resolve(e,M),{highWaterMark:4096}),a=new q.default.Reader,c=new W.Readable().wrap(a);a.on("format",async({audioFormat:w,sampleRate:A,channels:i})=>{if(w!=1||i!=1)throw new Error("Audio file must be WAV with mono PCM.");let l=new k.default.Recognizer({model:X,sampleRate:A});l.setMaxAlternatives(10),l.setWords(!0),l.setPartialWords(!0);for await(let C of c)if(l.acceptWaveform(C)){let E=l.result().alternatives.sort((u,p)=>p.confidence-u.confidence)[0].text;t.close(()=>o(E))}l.free()}),t.pipe(a)})}async function oe(e,o="ffmpeg"){let t=Y();d.default.writeFileSync(x.default.resolve(t,S),await e.body()),Z(t,o);let a=await ee(t);return d.default.rmSync(t,{recursive:!0}),a}0&&(module.exports={BFRAME,MAIN_FRAME,NotFoundError,exists,solve});
